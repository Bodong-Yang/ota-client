name: release

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: ubuntu-20.04
    timeout-minutes: 10
    steps:
      - name: checkout
        uses: actions/checkout@v2

      - name: setup python
        uses: actions/setup-python@v1
        with:
          python-version: 3.8

      - name: install build
        run: >-
          python -m pip install build

      - name: build a binary
        run: >-
          python -m
          build
          --wheel
          --outdir dist/
          .

      - name: build a proto binary
        run: |
          current_branch=$(git rev-parse --abbrev-ref HEAD)
          tags=git tag -l --sort=-creatordate --merged ${current_branch}
          echo "tags ${tags}"
          latest_tag=$(bash proto/pb2/latest_tag.sh)
          second_latest_tag=$(bash proto/pb2/latest_tag.sh second_latest)
          proto_diff=$(git diff --name-only ${second_latest_tag} ${latest_tag} proto/otaclient_v2.proto)
          echo "latest: ${latest_tag}, second latest: ${second_latest_tag}"
          echo "proto diff: ${proto_diff}"
          if [ "${proto_diff}" != "" ]; then
            cd proto
            make
          fi

      - name: release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/*.whl
            proto/pb2/dist/*.whl
